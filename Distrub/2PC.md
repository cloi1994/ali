### 2.2 阶段1

在阶段1中，协调者发起一个提议，分别问询各参与者是否接受

 

![image-20190126001216693](/Users/ck/Library/Application Support/typora-user-images/image-20190126001216693.png)

 

### 2.3 阶段2

在阶段2中，协调者根据参与者的反馈，提交或中止事务，如果参与者全部同意则提交，只要有一个参与者不同意就中止。

![image-20190126001222699](/Users/ck/Library/Application Support/typora-user-images/image-20190126001222699.png)

### 2.4 Failure

#### If Site failed：

- Commit => redo
- abort => undo
- Ready => consult Ci

#### If Ci failed:

Sites:

- commit => commit
- abort => abort
- Prepare => wait Ci recover ( Blocking )

### 2.5 优缺点

在异步环境并且没有节点宕机的模型下，2PC可以满足全认同、值合法、可结束，是解决一致性问题的一种协议。从协调者接收到一次事务请求、发起提议到事务完成，经过2PC协议后增加了2次RTT(propose+commit)，带来的时延增加相对较少。

二阶段提交有几个**缺点：**

- **同步阻塞问题**。执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。
- **单点故障**。由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）
- **数据不一致**。在二阶段提交的阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据不一致性的现象。
- **二阶段无法解决的问题**：协调者再发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交。

### 3PC

Three-Phase Commit，三阶段提交，分为CanCommit、PreCommit、do Commit三个阶段。

![image-20190126003915376](/Users/ck/Library/Application Support/typora-user-images/image-20190126003915376.png)



阶段三可能出现的问题：
协调者出现问题、协调者与参与者之间网络出现故障。不论出现哪种情况，最终都会导致参与者无法及时接收到来自协调者的doCommit或是abort请求，针对这种情况，参与者都会在等待超时后，继续进行事务提交（timeout后中断事务）。

优点：降低参与者阻塞范围，并能够在出现单点故障后继续达成一致
缺点：引入preCommit阶段，在这个阶段如果出现网络分区，协调者无法与参与者正常通信(abort)，参与者依然会进行事务提交，造成数据不一致

### 小结

二阶段提交协议解决了分布式事务的原子性问题，保证了分布式事务的多个参与者要么都执行成功，要么都执行失败。
三阶段提交协议在二阶段的基础上，添加了PreCommit过程，避免了二阶段协议中的无限期等待问题。

Poxos算法引入了“过半”的理论，即少数服从多数的原则，克服了过于保守的问题；通过支持分布式节点角色之间的轮换来避免单点问题；因此，它也解决了无限期等待问题和脑裂问题。

